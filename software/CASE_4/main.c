
#include "DE10_Lite_VGA_Driver.h"
#include "altera_avalon_timer_regs.h"
#include "draw_vga.h"
#include <io.h>
#include <stdio.h>
#include "system.h"
#include "alt_types.h"
#include "fir_driver.h"


#define SAMPLES 320
#define COEFFICIENTS 16

void fir_filter_nios(float samples,
                     float results){

  static const float coeffs[COEFFICIENTS] = {0.180603,0.045044,0.723145,0.347412,
                                             0.660522,0.383850,0.627319,0.021606,
                                             0.910522,0.800537,0.745789,0.813110,
                                             0.383301,0.617249,0.575439,0.530029};

  static float taps[COEFFICIENTS];

  float y = 0.0;

  // shift in input data
  for(int i = (COEFFICIENTS - 1); i > 0; --i) {
    taps[i] = taps[i-1];
  }

  // accumulate over all taps
  for(int i = (COEFFICIENTS - 1); i >= 0; --i) {
    y += taps[i] * coeffs[i];
  }
  results = y;
}



int main(){

float samples[SAMPLES] = {0.325806,0.345764,0.311218,0.352112,0.325806,0.368164,0.331116,0.378479,0.345825,0.375366,0.352539,0.384155,0.364746,0.392883,0.406799,0.397827,0.427124,0.405396,0.428772,0.407532,0.444519,0.421265,0.462097,0.441833,0.465759,0.448181,0.480347,0.449280,0.498962,0.458923,0.511108,0.485596,0.504700,0.490173,0.524780,0.497925,0.525940,0.518066,0.548157,0.519226,0.552429,0.517456,0.547485,0.540344,0.564087,0.546021,0.577698,0.548035,0.563477,0.545410,0.570679,0.553589,0.598572,0.568726,0.600586,0.568054,0.610535,0.568115,0.615723,0.577209,0.618286,0.582947,0.620728,0.592407,0.621826,0.598022,0.627075,0.606689,0.617676,0.590271,0.630188,0.608154,0.638123,0.600098,0.620483,0.609131,0.621521,0.595703,0.633423,0.614868,0.636719,0.613403,0.637939,0.609436,0.621460,0.601685,0.620911,0.602783,0.621521,0.611938,0.619568,0.599060,0.621887,0.594482,0.618530,0.592468,0.611511,0.582764,0.602112,0.596008,0.613770,0.572449,0.604919,0.578552,0.593445,0.577271,0.583740,0.560547,0.599976,0.569885,0.587524,0.545471,0.573303,0.557251,0.556763,0.539429,0.558594,0.523010,0.553589,0.526550,0.532349,0.517151,0.524048,0.513916,0.534363,0.492554,0.520996,0.479675,0.497131,0.487183,0.503296,0.465088,0.494873,0.450256,0.476318,0.461121,0.469421,0.439941,0.463257,0.422729,0.447998,0.414124,0.431885,0.400330,0.429932,0.389404,0.412781,0.385071,0.405457,0.383484,0.385986,0.369446,0.368042,0.349243,0.372803,0.346924,0.362427,0.322693,0.355347,0.309509,0.330688,0.302551,0.315735,0.292603,0.301636,0.275818,0.297913,0.270630,0.292114,0.252686,0.263916,0.234131,0.274048,0.234497,0.252930,0.225708,0.241150,0.209106,0.225586,0.197205,0.218689,0.184814,0.216919,0.170654,0.195801,0.166870,0.196533,0.152710,0.183228,0.148987,0.155457,0.127930,0.159485,0.116089,0.151001,0.106201,0.145264,0.102722,0.132996,0.106689,0.108459,0.084167,0.108398,0.092102,0.092712,0.079590,0.089600,0.063416,0.096802,0.071289,0.075195,0.051331,0.076904,0.039734,0.072632,0.038635,0.060120,0.047241,0.063660,0.028870,0.064270,0.039490,0.042419,0.026306,0.050964,0.015930,0.031860,0.011658,0.040039,0.018127,0.036011,0.007324,0.039185,0.013306,0.031860,0.004761,0.022888,0.008057,0.029785,0.017578,0.040894,0.001465,0.023315,0.007385,0.028809,0.019897,0.037720,0.012634,0.024414,0.006836,0.039612,0.020996,0.050354,0.020630,0.047974,0.012939,0.052979,0.031738,0.044739,0.020386,0.044128,0.042603,0.061279,0.027588,0.072327,0.044800,0.069763,0.036255,0.072754,0.046204,0.081299,0.054443,0.095886,0.071533,0.091309,0.069092,0.111023,0.074829,0.124573,0.102112,0.108643,0.088074,0.124451,0.100891,0.129944,0.116089,0.153809,0.126892,0.149963,0.136414,0.160889,0.151794,0.165466,0.144409,0.191406,0.163269,0.188843,0.172119,0.219116,0.179749,0.215942,0.203125,0.229675,0.202820,0.233276,0.230347,0.258911,0.224670,0.250488,0.247864,0.284424,0.250854,0.273071,0.272705,0.290955,0.270386,0.318726,0.289063,0.323486,0.299438};
float ref_result[320] = {0.059711,0.077871,0.308082,0.441543,0.635350,0.797830,0.977402,1.038975,1.296372,1.643296,1.836964,2.184047,2.274144,2.557777,2.735663,2.980330,3.011487,3.048910,3.114190,3.134253,3.207030,3.202753,3.315891,3.298000,3.420614,3.417305,3.520111,3.518152,3.621056,3.614128,3.712463,3.716098,3.803042,3.810050,3.898114,3.897572,3.993986,3.993594,4.070067,4.096663,4.162470,4.176553,4.248966,4.256997,4.318514,4.336266,4.404492,4.408775,4.487362,4.482511,4.525013,4.533298,4.588857,4.586046,4.655856,4.650345,4.710591,4.698774,4.769199,4.735541,4.823556,4.795197,4.874352,4.843754,4.927964,4.903775,4.980952,4.965878,5.017409,5.005745,5.045206,5.034653,5.076019,5.068699,5.109195,5.099554,5.131428,5.104655,5.136939,5.110401,5.160525,5.143346,5.165089,5.146295,5.180086,5.153939,5.179566,5.149765,5.172810,5.154760,5.179552,5.160893,5.175780,5.153745,5.164224,5.128724,5.140242,5.108168,5.119854,5.076242,5.099053,5.059055,5.085376,5.039075,5.058092,5.009200,5.010079,4.974324,4.991537,4.938869,4.959576,4.910804,4.919093,4.879820,4.885351,4.820965,4.825612,4.778560,4.790042,4.725453,4.716690,4.671748,4.657237,4.611512,4.595474,4.525511,4.525088,4.469759,4.456087,4.392564,4.376677,4.315076,4.327070,4.247975,4.257454,4.174378,4.160870,4.103997,4.103151,4.024501,4.024733,3.939320,3.921482,3.861594,3.852144,3.769365,3.766771,3.675901,3.668184,3.595445,3.580236,3.501524,3.481224,3.412441,3.378722,3.317830,3.288826,3.237235,3.212238,3.145503,3.123961,3.034005,3.026368,2.940914,2.932039,2.836968,2.824853,2.738387,2.720980,2.650593,2.617914,2.540175,2.511654,2.424693,2.412857,2.329685,2.327031,2.247691,2.230299,2.136228,2.129427,2.054465,2.040744,1.961629,1.944925,1.863025,1.858891,1.776422,1.771482,1.677440,1.683267,1.594068,1.578138,1.494426,1.495000,1.408265,1.409975,1.329624,1.320584,1.234805,1.240733,1.154117,1.150692,1.070544,1.059308,1.000250,0.979858,0.946105,0.915365,0.863509,0.846306,0.806375,0.786961,0.734097,0.728891,0.647304,0.667701,0.614453,0.617759,0.556226,0.571225,0.501091,0.523632,0.475604,0.463364,0.419973,0.432123,0.376953,0.384474,0.348452,0.349956,0.309665,0.326002,0.271528,0.287059,0.238582,0.246960,0.204181,0.226460,0.184417,0.201865,0.176190,0.205934,0.174322,0.184333,0.154106,0.174234,0.158068,0.192597,0.161849,0.179302,0.156230,0.184526,0.174574,0.217857,0.190251,0.224467,0.188682,0.240973,0.218397,0.269661,0.242063,0.281936,0.261217,0.308754,0.303212,0.348581,0.330737,0.360766,0.341339,0.404447,0.375976,0.441478,0.415471,0.487352,0.476476,0.536390,0.514175,0.584509,0.573484,0.642020,0.644061,0.699357,0.693162,0.763448,0.753190,0.823656,0.844326,0.898780,0.898925,0.959727,0.967107,1.026511,1.041311,1.099295,1.105231,1.178728,1.194036,1.258766,1.277445,1.364470,1.352192,1.437669,1.442927,1.525100,1.528110,1.613844,1.626186,1.706231,1.729918,1.795781,1.820192,1.893308,1.912952,1.986024,2.013458,2.077633,2.086173,2.179111,2.202001};
float output_comp[SAMPLES];

int timer_comp = 0, timer_nios = 0;

// Disable interrupts
	   sample_disable_interrupt();
	   sample_clear_done_status();

// Load samples in local memory (sample buffer)

  for (int i=0;i<SAMPLES;i++){
	  sample_memory_write((i<<2), *(alt_32 *) (&samples[i]));
  }
// Run component

// Write to argument registers

  sample_arg_N(320);

// Call sample buffer
  while (sample_busy()){}
  TIMER_RESET();
  TIMER_START();
  sample_start();
  while (!(sample_done())){}
  timer_comp = TIMER_READ();

// Read Result from local memory (result buffer)
  for (int i=0;i<SAMPLES;i++){
	  *(alt_32 *) (&output_comp[i]) = result_memory_read(i<<2);
	   printf ("output_comp: %f\n",output_comp[i]);
  }

  // Call function for execution time comparison
     TIMER_RESET();
     TIMER_START();
     for (int i=0;i<SAMPLES;i++){
        fir_filter_nios(samples[i], output_comp[i]);
     }
     timer_nios = TIMER_READ();

   // Print execution times
      printf("Execution time (comp): \t %d\n", timer_comp);
      printf("Execution time (nios): \t %d\n", timer_nios);

  // Check results
     float diff, tot_diff = 0.0;
     for (int i=0;i < SAMPLES;i++){
  	   diff =  output_comp[i] - ref_result[i];
  	   tot_diff += diff;
     }

     printf("TOTAL ERROR =%2.18f\n",tot_diff);

     float error_margin = 1.0;
     if (tot_diff < error_margin && tot_diff > -(error_margin))
  	   printf("\nTEST PASSED!\n");

     else
  	   printf("\nTEST FAILED!\n");

     return 0;
  }
